{% extends "base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Claim #{{ claim.id }}</h2>
        <span class="status-{{ claim.status.name }} status-badge" style="font-size: 1rem;">{{ claim.status.value }}</span>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
        <div>
            <p><strong>Type:</strong> {{ claim.type.value }}</p>
            <p><strong>Created:</strong> {{ claim.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
            <p><strong>Updated:</strong> {{ claim.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% if claim.resolved_at %}
            <p><strong>Resolved:</strong> {{ claim.resolved_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% endif %}
            
            {% if claim.photo_path %}
            <div style="margin-top: 1rem;">
                <strong>Photo:</strong><br>
                <img src="/uploads/{{ claim.photo_path }}" class="photo-preview" alt="Claim Photo" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p>Photo missing</p>')">
            </div>
            {% endif %}
        </div>
        
        <div>
            <h3>Edit Details</h3>
            <form action="/claims/{{ claim.id }}/update" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Severity</label>
                    <select name="severity">
                        {% for s in severities %}
                        <option value="{{ s.value }}" {% if claim.severity == s %}selected{% endif %}>{{ s.value }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="4">{{ claim.description }}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Update Photo</label>
                    <input type="file" name="photo" accept="image/*">
                </div>
                
                <button type="submit" class="button secondary">Save Changes</button>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <h3>Status & Resolution</h3>
    <form action="/claims/{{ claim.id }}/status" method="post">
        <div class="form-group">
            <label>Status</label>
            <select name="status" id="statusSelect" onchange="toggleResolutionFields()">
                {% for s in statuses %}
                <option value="{{ s.value }}" {% if claim.status == s %}selected{% endif %}>{{ s.value }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div id="resolutionFields" style="display: none;">
            <div class="form-group">
                <label>Resolution Outcome</label>
                <select name="resolution_outcome">
                    <option value="">-- Select Outcome --</option>
                    {% for o in outcomes %}
                    <option value="{{ o.value }}" {% if claim.resolution_outcome == o %}selected{% endif %}>{{ o.value }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>Resolved Note (Always Editable)</label>
            <textarea name="resolved_note" rows="2">{{ claim.resolved_note or '' }}</textarea>
        </div>
        
        <button type="submit" class="button primary">Update Status</button>
    </form>
</div>

<script>
    function toggleResolutionFields() {
        const status = document.getElementById('statusSelect').value;
        const fields = document.getElementById('resolutionFields');
        if (status === 'Resolved') {
            fields.style.display = 'block';
        } else {
            fields.style.display = 'none';
        }
    }
    toggleResolutionFields();
</script>
{% endblock %}
